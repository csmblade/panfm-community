-- ============================================================================
-- Migration 006: Nmap Network Scanning System Tables
-- ============================================================================
-- Purpose: Migrate nmap_scans.db from SQLite to TimescaleDB
-- Impact: Enables enterprise-grade security monitoring with hypertables
-- Created: 2025-11-20
-- Previous Migration: 005_alerts_schema.sql
-- ============================================================================

-- ============================================================================
-- Table 1: scheduled_scans
-- Purpose: Scheduled scan configurations (v1.12.0 feature)
-- ============================================================================
CREATE TABLE IF NOT EXISTS scheduled_scans (
    id SERIAL PRIMARY KEY,
    device_id TEXT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    target_type TEXT NOT NULL,        -- 'single_ip', 'subnet', 'range'
    target_value TEXT,                -- IP address, CIDR, or range
    scan_type TEXT NOT NULL DEFAULT 'balanced',  -- 'quick', 'balanced', 'thorough'
    schedule_type TEXT NOT NULL,      -- 'once', 'hourly', 'daily', 'weekly', 'monthly'
    schedule_value JSONB NOT NULL,    -- Schedule configuration (was TEXT)
    enabled BOOLEAN DEFAULT true,
    last_run_timestamp TIMESTAMPTZ,
    last_run_status TEXT,
    last_run_error TEXT,
    next_run_timestamp TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_by TEXT,
    updated_at TIMESTAMPTZ,
    updated_by TEXT
);

-- Index for enabled scans per device
CREATE INDEX IF NOT EXISTS idx_scheduled_scans_device_enabled
    ON scheduled_scans (device_id, enabled);

-- Index for next run scheduling
CREATE INDEX IF NOT EXISTS idx_scheduled_scans_next_run
    ON scheduled_scans (enabled, next_run_timestamp)
    WHERE enabled = true AND next_run_timestamp IS NOT NULL;

-- ============================================================================
-- Table 2: nmap_scan_history
-- Purpose: Complete nmap scan results (TIME-SERIES DATA)
-- ============================================================================
CREATE TABLE IF NOT EXISTS nmap_scan_history (
    id SERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),  -- Hypertable partition key
    device_id TEXT NOT NULL,
    target_ip INET NOT NULL,          -- Use PostgreSQL INET type for IP addresses
    scan_type TEXT NOT NULL,
    scan_timestamp TIMESTAMPTZ NOT NULL,
    scan_duration_seconds DOUBLE PRECISION,
    hostname TEXT,
    host_status TEXT,                 -- 'up', 'down', 'unknown'
    os_name TEXT,
    os_accuracy INTEGER,
    os_matches JSONB,                 -- Array of OS matches (was os_matches_json TEXT)
    total_ports INTEGER DEFAULT 0,
    open_ports_count INTEGER DEFAULT 0,
    scan_results JSONB,               -- Full scan results (was scan_results_json TEXT)
    raw_xml TEXT                      -- Raw nmap XML output (can be large)
);

-- Convert to hypertable (1-day chunks)
SELECT create_hypertable(
    'nmap_scan_history',
    'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE
);

-- Index for device and target lookups
CREATE INDEX IF NOT EXISTS idx_nmap_scan_history_device_target
    ON nmap_scan_history (device_id, target_ip, time DESC);

-- Index for scan timestamp queries
CREATE INDEX IF NOT EXISTS idx_nmap_scan_history_scan_timestamp
    ON nmap_scan_history (device_id, scan_timestamp DESC);

-- Index for host status filtering
CREATE INDEX IF NOT EXISTS idx_nmap_scan_history_status
    ON nmap_scan_history (device_id, host_status, time DESC);

-- Retention: 90 days (nmap scan data)
SELECT add_retention_policy(
    'nmap_scan_history',
    INTERVAL '90 days',
    if_not_exists => TRUE
);

-- Compression: After 7 days
ALTER TABLE nmap_scan_history SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id, target_ip',
    timescaledb.compress_orderby = 'time DESC'
);

SELECT add_compression_policy(
    'nmap_scan_history',
    INTERVAL '7 days',
    if_not_exists => TRUE
);

-- ============================================================================
-- Table 3: nmap_port_history
-- Purpose: Per-port details from nmap scans
-- ============================================================================
CREATE TABLE IF NOT EXISTS nmap_port_history (
    id SERIAL PRIMARY KEY,
    scan_id INTEGER NOT NULL REFERENCES nmap_scan_history(id) ON DELETE CASCADE,
    port_number INTEGER NOT NULL,
    protocol TEXT NOT NULL,           -- 'tcp', 'udp'
    state TEXT NOT NULL,              -- 'open', 'closed', 'filtered'
    service_name TEXT,
    service_product TEXT,
    service_version TEXT
);

-- Index for scan_id lookups
CREATE INDEX IF NOT EXISTS idx_nmap_port_history_scan
    ON nmap_port_history (scan_id, port_number);

-- Index for port number searches
CREATE INDEX IF NOT EXISTS idx_nmap_port_history_port
    ON nmap_port_history (port_number, state);

-- ============================================================================
-- Table 4: nmap_change_events
-- Purpose: Change detection (new ports, OS changes, etc.) - TIME-SERIES DATA
-- ============================================================================
CREATE TABLE IF NOT EXISTS nmap_change_events (
    id SERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),  -- Hypertable partition key
    device_id TEXT NOT NULL,
    target_ip INET NOT NULL,
    change_timestamp TIMESTAMPTZ NOT NULL,
    change_type TEXT NOT NULL,        -- 'new_port', 'closed_port', 'os_change', 'service_change'
    severity TEXT NOT NULL,           -- 'info', 'warning', 'critical'
    old_value TEXT,
    new_value TEXT,
    details JSONB,                    -- Change details (was details_json TEXT)
    acknowledged BOOLEAN DEFAULT false,
    acknowledged_at TIMESTAMPTZ,
    acknowledged_by TEXT
);

-- Convert to hypertable (1-day chunks)
SELECT create_hypertable(
    'nmap_change_events',
    'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE
);

-- Index for device and target lookups
CREATE INDEX IF NOT EXISTS idx_nmap_change_events_device_target
    ON nmap_change_events (device_id, target_ip, time DESC);

-- Index for unacknowledged changes
CREATE INDEX IF NOT EXISTS idx_nmap_change_events_acknowledged
    ON nmap_change_events (acknowledged, severity, time DESC)
    WHERE acknowledged = false;

-- Retention: 90 days (change events)
SELECT add_retention_policy(
    'nmap_change_events',
    INTERVAL '90 days',
    if_not_exists => TRUE
);

-- Compression: After 7 days
ALTER TABLE nmap_change_events SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id, target_ip',
    timescaledb.compress_orderby = 'time DESC'
);

SELECT add_compression_policy(
    'nmap_change_events',
    INTERVAL '7 days',
    if_not_exists => TRUE
);

-- ============================================================================
-- Table 5: scan_queue
-- Purpose: Scan execution queue with status tracking
-- ============================================================================
CREATE TABLE IF NOT EXISTS scan_queue (
    id SERIAL PRIMARY KEY,
    schedule_id INTEGER REFERENCES scheduled_scans(id) ON DELETE SET NULL,
    device_id TEXT NOT NULL,
    target_ip INET NOT NULL,
    scan_type TEXT NOT NULL,
    status TEXT NOT NULL,             -- 'queued', 'running', 'completed', 'failed'
    queued_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    scan_id INTEGER REFERENCES nmap_scan_history(id) ON DELETE SET NULL,
    error_message TEXT
);

-- Index for queue status queries
CREATE INDEX IF NOT EXISTS idx_scan_queue_status
    ON scan_queue (status, queued_at);

-- Index for schedule lookups
CREATE INDEX IF NOT EXISTS idx_scan_queue_schedule
    ON scan_queue (schedule_id, status);

-- ============================================================================
-- Table 6: connected_devices (NEW - replaces phantom SQLite table)
-- Purpose: Store connected devices from ARP/Nmap with bandwidth data
-- ============================================================================
CREATE TABLE IF NOT EXISTS connected_devices (
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    device_id TEXT NOT NULL,
    ip INET NOT NULL,
    mac MACADDR,
    hostname TEXT,
    interface TEXT,
    zone TEXT,
    ttl INTEGER,
    vendor TEXT,
    custom_name TEXT,                 -- Denormalized from device_metadata.json
    first_seen TIMESTAMPTZ DEFAULT NOW(),
    last_seen TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (time, device_id, ip)
);

-- Convert to hypertable (1-day chunks)
SELECT create_hypertable(
    'connected_devices',
    'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE
);

-- Index for device and IP lookups
CREATE INDEX IF NOT EXISTS idx_connected_devices_device_ip
    ON connected_devices (device_id, ip, time DESC);

-- Index for MAC lookups
CREATE INDEX IF NOT EXISTS idx_connected_devices_mac
    ON connected_devices (device_id, mac, time DESC)
    WHERE mac IS NOT NULL;

-- Retention: 7 days (ARP data is ephemeral)
SELECT add_retention_policy(
    'connected_devices',
    INTERVAL '7 days',
    if_not_exists => TRUE
);

-- Compression: After 1 day
ALTER TABLE connected_devices SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id, ip',
    timescaledb.compress_orderby = 'time DESC'
);

SELECT add_compression_policy(
    'connected_devices',
    INTERVAL '1 day',
    if_not_exists => TRUE
);

-- ============================================================================
-- Verification Queries
-- ============================================================================

DO $$
BEGIN
    RAISE NOTICE 'Nmap Network Scanning tables created successfully:';
    RAISE NOTICE '  ✓ scheduled_scans (scan scheduling configurations)';
    RAISE NOTICE '  ✓ nmap_scan_history (hypertable - full scan results)';
    RAISE NOTICE '  ✓ nmap_port_history (per-port scan details)';
    RAISE NOTICE '  ✓ nmap_change_events (hypertable - security change detection)';
    RAISE NOTICE '  ✓ scan_queue (scan execution queue)';
    RAISE NOTICE '  ✓ connected_devices (hypertable - ARP entries with bandwidth)';
    RAISE NOTICE '';
    RAISE NOTICE 'Hypertable configuration:';
    RAISE NOTICE '  - Scan history: 90 days retention, 7 days compression';
    RAISE NOTICE '  - Change events: 90 days retention, 7 days compression';
    RAISE NOTICE '  - Connected devices: 7 days retention, 1 day compression';
    RAISE NOTICE '';
    RAISE NOTICE 'Next steps:';
    RAISE NOTICE '  1. Run migrate_nmap_to_timescale.py to migrate data from nmap_scans.db';
    RAISE NOTICE '  2. Update scan_storage.py to use PostgreSQL';
    RAISE NOTICE '  3. Update throughput_storage_timescale.py connected_devices queries';
    RAISE NOTICE '  4. Test scan execution and change detection';
    RAISE NOTICE '  5. Remove nmap_scans.db after verification';
END $$;
