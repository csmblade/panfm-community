services:
  # =========================================
  # TimescaleDB - Time-Series Database (v2.0.0)
  # =========================================
  # Enterprise-grade PostgreSQL with TimescaleDB extension
  # Stores: Throughput metrics with 1-year retention
  # Starts automatically with: docker-compose up -d
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: panfm-timescaledb
    environment:
      - POSTGRES_USER=panfm
      - POSTGRES_PASSWORD=${TIMESCALE_PASSWORD:-panfm_secure_password}
      - POSTGRES_DB=panfm_db
    ports:
      - "5432:5432"  # PostgreSQL port (can disable in production)
    volumes:
      - ./timescaledb_data:/var/lib/postgresql/data
      - ./init_timescaledb.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U panfm"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - panfm-network
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # =========================================
  # PANfm Web Process
  # =========================================
  panfm:
    build: .
    container_name: panfm
    ports:
      - "3000:3000"
    volumes:
      # Persist data files (create these as files first, not directories)
      # Run setup.sh before starting to create all required files
      # Files: settings.json devices.json encryption.key auth.json device_metadata.json mac_vendor_db.json service_port_db.json alerts.db
      # Note: throughput_history.db removed in v2.0.0 (replaced by TimescaleDB)
      - ./settings.json:/app/settings.json
      - ./devices.json:/app/devices.json
      - ./encryption.key:/app/encryption.key
      - ./auth.json:/app/auth.json
      - ./device_metadata.json:/app/device_metadata.json
      - ./mac_vendor_db.json:/app/mac_vendor_db.json
      - ./service_port_db.json:/app/service_port_db.json
      - ./alerts.db:/app/alerts.db
      # Persist Flask secret key and sessions across container restarts (v1.14.0 - Enterprise Reliability)
      - ./data:/app/data
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      # TimescaleDB connection (v2.0.0)
      - USE_TIMESCALE=true
      - TIMESCALE_HOST=timescaledb
      - TIMESCALE_PORT=5432
      - TIMESCALE_USER=panfm
      - TIMESCALE_PASSWORD=${TIMESCALE_PASSWORD:-panfm_secure_password}
      - TIMESCALE_DB=panfm_db
    restart: unless-stopped
    command: gunicorn --bind 0.0.0.0:3000 --worker-class gthread --workers 1 --threads 8 --worker-tmp-dir /dev/shm --timeout 120 --access-logfile - --error-logfile - app:app
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3000/login', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Allow time for first data collection
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - panfm-network

  # =========================================
  # PANfm Clock Process (Background Scheduler)
  # =========================================
  panfm-clock:
    build: .
    container_name: panfm-clock
    volumes:
      # Clock process shares same data files as web service
      - ./settings.json:/app/settings.json
      - ./devices.json:/app/devices.json
      - ./encryption.key:/app/encryption.key
      - ./device_metadata.json:/app/device_metadata.json
      - ./mac_vendor_db.json:/app/mac_vendor_db.json
      - ./service_port_db.json:/app/service_port_db.json
      - ./alerts.db:/app/alerts.db
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - PYTHONUNBUFFERED=1
      # TimescaleDB connection (v2.0.0)
      - USE_TIMESCALE=true
      - TIMESCALE_HOST=timescaledb
      - TIMESCALE_PORT=5432
      - TIMESCALE_USER=panfm
      - TIMESCALE_PASSWORD=${TIMESCALE_PASSWORD:-panfm_secure_password}
      - TIMESCALE_DB=panfm_db
    restart: unless-stopped
    command: python -u clock.py
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/clock.py') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Allow time for initialization and first collection
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - panfm-network

# =========================================
# Networks
# =========================================
networks:
  panfm-network:
    driver: bridge
