services:
  panfm:
    build: .
    container_name: panfm
    ports:
      - "3000:3000"
    volumes:
      # Persist data files (create these as files first, not directories)
      # Run setup.sh before starting to create all required files
      # Files: settings.json devices.json encryption.key auth.json device_metadata.json mac_vendor_db.json service_port_db.json throughput_history.db alerts.db nmap_scans.db
      - ./settings.json:/app/settings.json
      - ./devices.json:/app/devices.json
      - ./encryption.key:/app/encryption.key
      - ./auth.json:/app/auth.json
      - ./device_metadata.json:/app/device_metadata.json
      - ./mac_vendor_db.json:/app/mac_vendor_db.json
      - ./service_port_db.json:/app/service_port_db.json
      - ./throughput_history.db:/app/throughput_history.db
      - ./alerts.db:/app/alerts.db
      - ./nmap_scans.db:/app/nmap_scans.db
      # Persist Flask sessions across workers and container restarts
      - ./data/flask_session:/app/data/flask_session
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=False
    restart: unless-stopped
    command: gunicorn --bind 0.0.0.0:3000 --worker-class gthread --workers 1 --threads 8 --worker-tmp-dir /dev/shm --timeout 120 --access-logfile - --error-logfile - app:app

  panfm-clock:
    build: .
    container_name: panfm-clock
    volumes:
      # Clock process shares same data files as web service
      - ./settings.json:/app/settings.json
      - ./devices.json:/app/devices.json
      - ./encryption.key:/app/encryption.key
      - ./device_metadata.json:/app/device_metadata.json
      - ./mac_vendor_db.json:/app/mac_vendor_db.json
      - ./service_port_db.json:/app/service_port_db.json
      - ./throughput_history.db:/app/throughput_history.db
      - ./alerts.db:/app/alerts.db
      - ./nmap_scans.db:/app/nmap_scans.db
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    command: python -u clock.py
